# 図書館管理システム API テスト計画

このドキュメントでは、図書館管理システム API のテスト計画とテストケースについて説明します。

## テスト対象

- ユーザー管理 API 
- 本管理 API
- 著者管理 API
- カテゴリ管理 API
- 貸出管理 API

## テスト環境

- テストフレームワーク: Vitest
- HTTP クライアント: SuperTest
- データベース: SQLite (インメモリモード)

## テスト方針

1. **ユニットテスト**: 個々の関数やメソッドの動作を検証
2. **統合テスト**: コンポーネント間の連携を検証
3. **APIテスト**: エンドポイントの動作を検証

## テストデータ

テスト用のダミーデータをシードデータとして用意し、各テスト実行前にデータベースに投入します。

## テストケース

### ユーザーAPI (userRoutes)

#### ユニットテスト

| ID | テスト名 | 概要 | 期待結果 |
|----|----------|------|----------|
| U-UT-01 | ユーザー作成 - 正常系 | 有効なユーザーデータでユーザーを作成 | ユーザーが作成され、201が返される |
| U-UT-02 | ユーザー作成 - 異常系 (重複メールアドレス) | 既存のメールアドレスでユーザーを作成 | 400エラーが返される |
| U-UT-03 | ユーザー取得 - 正常系 | 既存のユーザーIDでユーザーを取得 | ユーザー情報が返される |
| U-UT-04 | ユーザー取得 - 異常系 (存在しないID) | 存在しないIDでユーザーを取得 | 404エラーが返される |
| U-UT-05 | ユーザー更新 - 正常系 | 既存のユーザーの情報を更新 | 更新されたユーザー情報が返される |
| U-UT-06 | ユーザー削除 - 正常系 | 貸出のないユーザーを削除 | 204が返される |
| U-UT-07 | ユーザー削除 - 異常系 (未返却あり) | 未返却の貸出があるユーザーを削除 | 400エラーが返される |

#### 統合テスト (API)

| ID | テスト名 | 概要 | 期待結果 |
|----|----------|------|----------|
| U-IT-01 | ユーザー一覧取得 | GETリクエストでユーザー一覧を取得 | ユーザーリストとページネーション情報が返される |
| U-IT-02 | ユーザーCRUD操作 | ユーザーの作成、取得、更新、削除を連続して実行 | 各操作が正常に完了する |

### 本API (bookRoutes)

#### ユニットテスト

| ID | テスト名 | 概要 | 期待結果 |
|----|----------|------|----------|
| B-UT-01 | 本作成 - 正常系 | 有効なデータで本を作成 | 本が作成され、201が返される |
| B-UT-02 | 本作成 - 異常系 (重複ISBN) | 既存のISBNで本を作成 | 400エラーが返される |
| B-UT-03 | 本作成 - 異常系 (存在しない著者) | 存在しない著者IDで本を作成 | 404エラーが返される |
| B-UT-04 | 本取得 - 正常系 | 既存の本IDで本を取得 | 本の情報が返される |
| B-UT-05 | 本更新 - 正常系 | 既存の本の情報を更新 | 更新された本の情報が返される |
| B-UT-06 | 本更新 - 正常系 (カテゴリ変更) | 本のカテゴリを変更 | 更新された本とカテゴリ情報が返される |
| B-UT-07 | 本削除 - 正常系 | 貸出のない本を削除 | 204が返される |
| B-UT-08 | 本削除 - 異常系 (貸出中) | 貸出中の本を削除 | 400エラーが返される |

#### 統合テスト (API)

| ID | テスト名 | 概要 | 期待結果 |
|----|----------|------|----------|
| B-IT-01 | 本一覧取得 | GETリクエストで本一覧を取得 | 本リストとページネーション情報が返される |
| B-IT-02 | 本CRUD操作 | 本の作成、取得、更新、削除を連続して実行 | 各操作が正常に完了する |
| B-IT-03 | 本とカテゴリの関連付け | 本を作成し、複数のカテゴリと関連付け | 正しい関連付けがされる |

### 著者API (authorRoutes)

#### ユニットテスト

| ID | テスト名 | 概要 | 期待結果 |
|----|----------|------|----------|
| A-UT-01 | 著者作成 - 正常系 | 有効なデータで著者を作成 | 著者が作成され、201が返される |
| A-UT-02 | 著者取得 - 正常系 | 既存の著者IDで著者を取得 | 著者の情報が返される |
| A-UT-03 | 著者更新 - 正常系 | 既存の著者の情報を更新 | 更新された著者の情報が返される |
| A-UT-04 | 著者削除 - 正常系 | 本のない著者を削除 | 204が返される |
| A-UT-05 | 著者削除 - 異常系 (本あり) | 本がある著者を削除 | 400エラーが返される |

#### 統合テスト (API)

| ID | テスト名 | 概要 | 期待結果 |
|----|----------|------|----------|
| A-IT-01 | 著者一覧取得 | GETリクエストで著者一覧を取得 | 著者リストとページネーション情報が返される |
| A-IT-02 | 著者CRUD操作 | 著者の作成、取得、更新、削除を連続して実行 | 各操作が正常に完了する |
| A-IT-03 | 著者と本の関連付け | 著者を作成し、複数の本と関連付け | 正しい関連付けがされる |

### カテゴリAPI (categoryRoutes)

#### ユニットテスト

| ID | テスト名 | 概要 | 期待結果 |
|----|----------|------|----------|
| C-UT-01 | カテゴリ作成 - 正常系 | 有効なデータでカテゴリを作成 | カテゴリが作成され、201が返される |
| C-UT-02 | カテゴリ作成 - 異常系 (名前重複) | 既存の名前でカテゴリを作成 | 400エラーが返される |
| C-UT-03 | カテゴリ取得 - 正常系 | 既存のカテゴリIDでカテゴリを取得 | カテゴリの情報が返される |
| C-UT-04 | カテゴリ更新 - 正常系 | 既存のカテゴリの情報を更新 | 更新されたカテゴリの情報が返される |
| C-UT-05 | カテゴリ削除 - 正常系 | 本のないカテゴリを削除 | 204が返される |
| C-UT-06 | カテゴリ削除 - 異常系 (本あり) | 本があるカテゴリを削除 | 400エラーが返される |

#### 統合テスト (API)

| ID | テスト名 | 概要 | 期待結果 |
|----|----------|------|----------|
| C-IT-01 | カテゴリ一覧取得 | GETリクエストでカテゴリ一覧を取得 | カテゴリリストとページネーション情報が返される |
| C-IT-02 | カテゴリCRUD操作 | カテゴリの作成、取得、更新、削除を連続して実行 | 各操作が正常に完了する |

### 貸出API (loanRoutes)

#### ユニットテスト

| ID | テスト名 | 概要 | 期待結果 |
|----|----------|------|----------|
| L-UT-01 | 貸出作成 - 正常系 | 有効なデータで貸出を作成 | 貸出が作成され、本の利用可能数が減少し、201が返される |
| L-UT-02 | 貸出作成 - 異常系 (本が利用不可) | 利用可能数が0の本で貸出を作成 | 400エラーが返される |
| L-UT-03 | 貸出更新 (返却) - 正常系 | 貸出に返却日を設定 | 貸出が更新され、本の利用可能数が増加する |
| L-UT-04 | 貸出取得 - 正常系 | 既存の貸出IDで貸出を取得 | 貸出の情報が返される |
| L-UT-05 | 貸出削除 - 正常系 | 返却済みの貸出を削除 | 204が返される |
| L-UT-06 | 貸出削除 - 異常系 (未返却) | 未返却の貸出を削除 | 400エラーが返される |

#### 統合テスト (API)

| ID | テスト名 | 概要 | 期待結果 |
|----|----------|------|----------|
| L-IT-01 | 貸出一覧取得 | GETリクエストで貸出一覧を取得 | 貸出リストとページネーション情報が返される |
| L-IT-02 | アクティブな貸出一覧取得 | GETリクエスト（active=true）でアクティブな貸出一覧を取得 | 未返却の貸出リストが返される |
| L-IT-03 | 貸出フロー | 貸出の作成、取得、返却、削除を連続して実行 | 各操作が正常に完了し、本の利用可能数が適切に変化する |

## 結合テスト

| ID | テスト名 | 概要 | 期待結果 |
|----|----------|------|----------|
| E2E-01 | 本の貸出フロー | ユーザー作成→本作成→貸出→返却の一連の流れをテスト | 一連の操作が正常に完了し、データが正しく更新される |
| E2E-02 | 本の管理フロー | 著者作成→カテゴリ作成→本作成→本の更新→カテゴリ変更の一連の流れをテスト | 一連の操作が正常に完了し、データが正しく更新される |

## テスト自動化

- CIパイプラインでの自動テスト実行
- カバレッジレポートの生成
- デプロイ前の品質ゲートとしてのテスト

## モックとスタブ

- データベース操作のモック化
- 外部依存のスタブ化

## テスト実行方法

```bash
# すべてのテストを実行
npm test

# テスト監視モード
npm run test:watch

# カバレッジレポート生成
npm run test:coverage
```

## テストディレクトリ構造

```
tests/
  ├── unit/
  │   ├── controllers/
  │   │   ├── userController.test.ts
  │   │   ├── bookController.test.ts
  │   │   ├── authorController.test.ts
  │   │   ├── categoryController.test.ts
  │   │   └── loanController.test.ts
  │   └── middlewares/
  │       └── errorHandler.test.ts
  ├── integration/
  │   ├── routes/
  │   │   ├── userRoutes.test.ts
  │   │   ├── bookRoutes.test.ts
  │   │   ├── authorRoutes.test.ts
  │   │   ├── categoryRoutes.test.ts
  │   │   └── loanRoutes.test.ts
  │   └── api.test.ts
  ├── e2e/
  │   ├── loanFlow.test.ts
  │   └── bookManagement.test.ts
  └── fixtures/
      └── testData.ts
```